<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NCERT Quiz</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="q_history.js"></script>
<script src="q_geography.js"></script>
<script src="q_polity.js"></script>
<script src="q_economics.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#FFF8F0;min-height:100vh;}
.header{background:linear-gradient(135deg,#FF6B00,#FFB300);padding:14px;text-align:center;}
.header h1{color:white;font-size:20px;font-weight:800;}
.header p{color:rgba(255,255,255,0.9);font-size:11px;}
.tabs{display:flex;gap:6px;padding:10px;overflow-x:auto;background:white;border-bottom:2px solid #F0E6D3;}
.tab{flex-shrink:0;padding:6px 14px;border:2px solid transparent;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;background:#F5F5F5;color:#666;}
.tab.active{background:#FF6B00;color:white;}
.stats{display:flex;justify-content:space-around;padding:10px;background:white;border-bottom:1px solid #eee;}
.stat{text-align:center;}
.sv{font-size:20px;font-weight:800;color:#FF6B00;}
.sv.g{color:#2E7D32;}
.sv.r{color:#C62828;}
.sl{font-size:10px;color:#888;}
.premium{background:linear-gradient(135deg,#1A1A2E,#0D47A1);color:white;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;font-size:11px;}
.pbtn{background:#FFB300;color:#333;border:none;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;}
.main{padding:12px;}
.progress-bar{background:#F0E6D3;border-radius:10px;height:8px;margin-bottom:10px;overflow:hidden;}
.progress-fill{background:linear-gradient(90deg,#FF6B00,#FFB300);height:100%;border-radius:10px;transition:width 0.3s;}
.qinfo{display:flex;justify-content:space-between;font-size:11px;color:#888;margin-bottom:8px;}
.card{background:white;border-radius:16px;padding:16px;box-shadow:0 4px 20px rgba(255,107,0,0.15);border-left:5px solid #FF6B00;}
.meta{display:flex;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:4px;}
.badge{background:#FFF3CD;color:#8B6914;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;}
.etag{background:#E8EAF6;color:#3949AB;font-size:10px;padding:3px 8px;border-radius:10px;}
.qhi{font-size:15px;font-weight:700;line-height:1.6;margin-bottom:6px;}
.qen{font-size:12px;color:#666;font-style:italic;margin-bottom:12px;padding-bottom:10px;border-bottom:1px dashed #EEE;}
.opts{display:flex;flex-direction:column;gap:8px;}
.opt{display:flex;align-items:center;gap:10px;padding:10px 14px;border:2px solid #E8E8E8;border-radius:12px;background:#FAFAFA;cursor:pointer;width:100%;text-align:left;font-family:inherit;transition:all 0.2s;}
.opt:hover:not(:disabled){border-color:#FF6B00;background:#FFF5EC;}
.ol{width:28px;height:28px;border-radius:50%;background:#F0F0F0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0;color:#666;}
.ohi{font-size:13px;font-weight:600;}
.oen{font-size:11px;color:#888;font-style:italic;}
.opt.correct{border-color:#2E7D32;background:#E8F5E9;}
.opt.correct .ol{background:#2E7D32;color:white;}
.opt.wrong{border-color:#C62828;background:#FFEBEE;}
.opt.wrong .ol{background:#C62828;color:white;}
.opt.show{border-color:#2E7D32;background:#E8F5E9;opacity:0.8;}
.exp{margin-top:12px;padding:12px;background:#FFF8E1;border-radius:10px;border-left:4px solid #FFB300;display:none;}
.etitle{font-size:12px;font-weight:700;color:#7B5800;margin-bottom:6px;}
.ehi{font-size:13px;color:#5D4037;line-height:1.6;}
.een{font-size:11px;color:#795548;font-style:italic;margin-top:4px;}
.next{width:100%;padding:14px;background:linear-gradient(135deg,#FF6B00,#E55A00);color:white;border:none;border-radius:14px;font-family:inherit;font-size:16px;font-weight:800;cursor:pointer;margin-top:10px;display:none;}
.next.show{display:block;}
.complete-card{background:white;border-radius:16px;padding:24px;text-align:center;box-shadow:0 4px 20px rgba(255,107,0,0.15);}
.complete-card h2{font-size:22px;margin-bottom:8px;}
.complete-card p{color:#666;font-size:14px;margin-bottom:16px;line-height:1.8;}
.restart-btn{background:linear-gradient(135deg,#FF6B00,#E55A00);color:white;border:none;border-radius:14px;padding:14px 28px;font-size:16px;font-weight:800;cursor:pointer;font-family:inherit;}
</style>
</head>
<body>
<div class="header">
  <h1>üéØ NCERT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ Quiz</h1>
  <p>‡§ï‡§ï‡•ç‡§∑‡§æ 6-12 | ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‚Ä¢ ‡§≠‡•Ç‡§ó‡•ã‡§≤ ‚Ä¢ ‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞ ‚Ä¢ ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø</p>
</div>
<div class="tabs">
  <button class="tab active" onclick="setSub(this,'history')">‚öîÔ∏è ‡§á‡§§‡§ø‡§π‡§æ‡§∏</button>
  <button class="tab" onclick="setSub(this,'geography')">üåç ‡§≠‡•Ç‡§ó‡•ã‡§≤</button>
  <button class="tab" onclick="setSub(this,'economics')">üìà ‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞</button>
  <button class="tab" onclick="setSub(this,'polity')">üèõÔ∏è ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø</button>
  <button class="tab" onclick="setSub(this,'mixed')">üé≤ ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§</button>
</div>
<div class="stats">
  <div class="stat"><div class="sv" id="t">0</div><div class="sl">‡§ï‡•Å‡§≤</div></div>
  <div class="stat"><div class="sv g" id="c">0</div><div class="sl">‡§∏‡§π‡•Ä ‚úì</div></div>
  <div class="stat"><div class="sv r" id="w">0</div><div class="sl">‡§ó‡§≤‡§§ ‚úó</div></div>
  <div class="stat"><div class="sv" id="s">0üî•</div><div class="sl">‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï</div></div>
</div>
<div class="premium">
  <span>‚ú® UPSC | SSC | Railway | CTET</span>
  <button class="pbtn" id="qcountbtn">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ...</button>
</div>
<div class="main">
  <div class="progress-bar"><div class="progress-fill" id="progfill" style="width:0%"></div></div>
  <div class="qinfo">
    <span id="qnum">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ...</span>
    <span id="qpct">0% ‡§™‡•Ç‡§∞‡§æ</span>
  </div>
  <div id="quizarea">
    <div class="card" id="card">
      <div class="meta"><span class="badge" id="qb"></span><span class="etag" id="qt"></span></div>
      <div class="qhi" id="qh"></div>
      <div class="qen" id="qe"></div>
      <div class="opts" id="opts"></div>
      <div class="exp" id="exp">
        <div class="etitle">üí° ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ | Explanation</div>
        <div class="ehi" id="eh"></div>
        <div class="een" id="ee"></div>
      </div>
      <button class="next" id="next" onclick="nextQ()">‚û°Ô∏è ‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® | Next Question</button>
    </div>
  </div>
</div>

<script>
if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand();}

// Combine all questions
var ALL_Q = [].concat(
  (typeof Q_HISTORY!=='undefined'?Q_HISTORY:[]),
  (typeof Q_GEOGRAPHY!=='undefined'?Q_GEOGRAPHY:[]),
  (typeof Q_POLITY!=='undefined'?Q_POLITY:[]),
  (typeof Q_ECONOMICS!=='undefined'?Q_ECONOMICS:[])
);

document.getElementById('qcountbtn').textContent = ALL_Q.length + '+ MCQs';

var SUBNAMES = {history:"‡§á‡§§‡§ø‡§π‡§æ‡§∏", geography:"‡§≠‡•Ç‡§ó‡•ã‡§≤", economics:"‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞", polity:"‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø", mixed:"‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§"};
var sub = "history";
var stats = {t:0, c:0, w:0, s:0};
var deck = [];
var deckIdx = 0;
var answered = false;
var cur = null;

// Fisher-Yates shuffle with seed based on subject+date
// This makes the order same for same user on same day, but different per subject
function shuffle(arr) {
  var a = arr.slice();
  for(var i = a.length-1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i+1));
    var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
  }
  return a;
}

// Storage key per subject
function storageKey(s) {
  return 'ncert_deck_' + s;
}

function getPool() {
  return sub === 'mixed' ? ALL_Q : ALL_Q.filter(function(q){ return q.s === sub; });
}

// Build question IDs from pool
function poolIds(pool) {
  return pool.map(function(q, i){ return i; });
}

// Save current deck progress to localStorage
function saveDeck() {
  try {
    var data = {
      order: deck.map(function(q){ return ALL_Q.indexOf(q); }),
      idx: deckIdx
    };
    localStorage.setItem(storageKey(sub), JSON.stringify(data));
  } catch(e) {}
}

// Load saved deck or create new shuffled deck
function loadOrCreateDeck() {
  var pool = getPool();
  try {
    var saved = localStorage.getItem(storageKey(sub));
    if(saved) {
      var data = JSON.parse(saved);
      // Restore deck from saved order
      var restored = data.order.map(function(i){ return ALL_Q[i]; }).filter(function(q){ return q && q.s === (sub==='mixed'?q.s:sub); });
      // Only restore if pool size matches (i.e. no new questions added)
      if(restored.length === pool.length) {
        deck = restored;
        deckIdx = data.idx || 0;
        // If already completed, reset
        if(deckIdx >= deck.length) {
          deck = shuffle(pool);
          deckIdx = 0;
          saveDeck();
        }
        return;
      }
    }
  } catch(e) {}
  // Fresh deck
  deck = shuffle(pool);
  deckIdx = 0;
  saveDeck();
}

function setSub(btn, s) {
  document.querySelectorAll('.tab').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  sub = s;
  stats = {t:0, c:0, w:0, s:0};
  updateStats();
  loadOrCreateDeck();
  renderQ();
}

function renderQ() {
  if(deckIdx >= deck.length) {
    showComplete();
    return;
  }
  answered = false;
  cur = deck[deckIdx];

  document.getElementById('next').classList.remove('show');
  document.getElementById('exp').style.display = 'none';

  var pct = Math.round((deckIdx / deck.length) * 100);
  document.getElementById('progfill').style.width = pct + '%';
  document.getElementById('qnum').textContent = '‡§™‡•ç‡§∞‡§∂‡•ç‡§® ' + (deckIdx+1) + '/' + deck.length;
  document.getElementById('qpct').textContent = pct + '% ‡§™‡•Ç‡§∞‡§æ';

  document.getElementById('qb').textContent = cur.c + ' | ' + SUBNAMES[sub];
  document.getElementById('qt').textContent = cur.t;
  document.getElementById('qh').textContent = cur.qh;
  document.getElementById('qe').textContent = cur.qe;

  var o = document.getElementById('opts');
  o.innerHTML = '';
  cur.o.forEach(function(opt) {
    var b = document.createElement('button');
    b.className = 'opt';
    b.innerHTML = '<div class="ol">'+opt.l+'</div><div><div class="ohi">'+opt.h+'</div><div class="oen">'+opt.e+'</div></div>';
    b.onclick = function(){ pick(opt.l, b); };
    o.appendChild(b);
  });

  // Make sure card is visible
  var qa = document.getElementById('quizarea');
  if(!document.getElementById('card').parentElement || document.getElementById('card').parentElement !== qa) {
    qa.innerHTML = '';
    qa.appendChild(document.getElementById('card'));
  }
}

function pick(letter, btn) {
  if(answered) return;
  answered = true;
  stats.t++;
  document.querySelectorAll('.opt').forEach(function(b){ b.disabled = true; });

  if(letter === cur.a) {
    btn.classList.add('correct');
    stats.c++; stats.s++;
    if(window.Telegram&&Telegram.WebApp&&Telegram.WebApp.HapticFeedback)
      Telegram.WebApp.HapticFeedback.notificationOccurred('success');
  } else {
    btn.classList.add('wrong');
    stats.w++; stats.s = 0;
    document.querySelectorAll('.opt').forEach(function(b){
      if(b.querySelector('.ol').textContent === cur.a) b.classList.add('show');
    });
    if(window.Telegram&&Telegram.WebApp&&Telegram.WebApp.HapticFeedback)
      Telegram.WebApp.HapticFeedback.notificationOccurred('error');
  }
  updateStats();
  document.getElementById('eh').textContent = cur.eh;
  document.getElementById('ee').textContent = cur.ee;
  document.getElementById('exp').style.display = 'block';
  document.getElementById('next').classList.add('show');
}

function nextQ() {
  deckIdx++;
  saveDeck(); // Save progress after every question
  renderQ();
}

function updateStats() {
  document.getElementById('t').textContent = stats.t;
  document.getElementById('c').textContent = stats.c;
  document.getElementById('w').textContent = stats.w;
  document.getElementById('s').textContent = stats.s + 'üî•';
}

function showComplete() {
  var pct = stats.t > 0 ? Math.round((stats.c/stats.t)*100) : 0;
  var emoji = pct>=80?'üèÜ':pct>=60?'üëç':'üìö';
  document.getElementById('progfill').style.width = '100%';
  document.getElementById('qnum').textContent = '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§∞‡•á! ‚úÖ';
  document.getElementById('qpct').textContent = '100% ‡§™‡•Ç‡§∞‡§æ';

  // Clear saved progress so next time fresh shuffle
  try { localStorage.removeItem(storageKey(sub)); } catch(e) {}

  document.getElementById('quizarea').innerHTML =
    '<div class="complete-card">'
    + '<div style="font-size:48px">'+emoji+'</div>'
    + '<h2>‡§∂‡§æ‡§¨‡§æ‡§∂! üéâ</h2>'
    + '<p>‡§∏‡§≠‡•Ä <b>'+deck.length+'</b> ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§∞‡•á ‡§π‡•ã ‡§ó‡§è!<br>'
    + '‡§∏‡§π‡•Ä: <b>'+stats.c+'/'+stats.t+'</b> ('+pct+'%)<br><br>'
    + 'üîÑ ‡§Ö‡§¨ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§™‡§∞<br>‡§®‡§è ‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§è‡§Ç‡§ó‡•á!</p>'
    + '<button class="restart-btn" onclick="restartDeck()">üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>'
    + '</div>';
}

function restartDeck() {
  stats = {t:0, c:0, w:0, s:0};
  updateStats();
  var pool = getPool();
  deck = shuffle(pool);
  deckIdx = 0;
  saveDeck();
  // Re-attach card
  var qa = document.getElementById('quizarea');
  qa.innerHTML = '';
  qa.appendChild(document.getElementById('card'));
  renderQ();
}

// Start
loadOrCreateDeck();
renderQ();
</script>
</body>
</html>
